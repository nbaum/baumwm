This is a horrible mess of terrible code.
